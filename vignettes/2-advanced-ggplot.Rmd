---
title: "Advanced examples in ggplot"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Advanced examples in ggplot}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

**Authors:** Lewis A. Jones & William Gearty

**Last updated:** `r Sys.Date()`

```{r setup, include = FALSE, eval = TRUE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE, eval = TRUE,
                      out.width = "100%", fig.width = 7.2, fig.height = 7.2,
                      dpi = 200)
library(devtools)
load_all()
```

<div style="text-align: justify">

# Introduction

Herein we provide three example applications of the __rphylopic__ package in combination with the __ggplot2__ package. However, note that all demonstrated functionality is also available for base R and showcased in a [separate vignette](3-advanced-base.html).

# Basic accession and transformation

The rphylopic package provides robust and flexible tools to access and transform PhyloPic silhouettes. Here we demonstrate this using the example dataset of Antarctic penguins from the __palmerpenguins__ R package.

First, let's load our libraries and the penguin data:

```{r}
# Load libraries
library(rphylopic)
library(ggplot2)
library(palmerpenguins)
# Get penguin data
data(penguins)
```

Now, let's pick a silhouette to use for the penguins. Let's pick #2:

```{r, eval = FALSE}
# Pick a silhouette for Pygoscelis (here we pick #2)
penguin <- pick_phylopic("Pygoscelis", n = 3, view = 3)
```

```{r, echo = FALSE}
penguin <- get_phylopic("86334821-42ec-4da1-bb9d-53f3d6941c77")
```

You may have noticed in the preview that the silhouette was a little slanted. Let's rotate it just a smidge:

```{r}
# It's a little slanted, so let's rotate it a little bit
penguin_rot <- rotate_phylopic(penguin, 15)
```

Now, let's put together the plot that we want to make. In this case, let's plot the penguins' bill lengths vs. their flipper lengths:

```{r}
ggplot(subset(penguins, !is.na(sex))) +
  geom_point(aes(x = bill_length_mm, y = flipper_length_mm)) +
  labs(x = "Bill length (mm)", y = "Flipper length (mm)") +
  scale_size_continuous(guide = NULL) +
  scale_colour_manual("Sex", values = c("orange", "blue"),
                      labels = c("Female", "Male")) +
  facet_wrap(~species, ncol = 1) +
  theme_bw(base_size = 15) +
  theme(legend.position = c(0.9, 0.9))
```

That's a nice basic plot! But you know what would make it nicer? If we used little penguins instead of points! To do that, we can use the `geom_phylopic` function instead of the `geom_point` function. Note that we need to wrap the penguin image in a `list()` call to make it a repeatable object (in this case, we want to use the same image for each x-y pair):

```{r}
ggplot(subset(penguins, !is.na(sex))) +
  geom_phylopic(img = list(penguin_rot),
                aes(x = bill_length_mm, y = flipper_length_mm)) +
  labs(x = "Bill length (mm)", y = "Flipper length (mm)") +
  facet_wrap(~species, ncol = 1) +
  theme_bw(base_size = 15) +
  theme(legend.position = c(0.9, 0.9))
```

Wow, those are some tiny silhouettes! Let's make the size of the silhouettes relative to the penguins' body masses. __ggplot2__ should work its magic and make them reasonable sizes for the plot:

```{r}
ggplot(subset(penguins, !is.na(sex))) +
  geom_phylopic(img = list(penguin_rot),
                aes(x = bill_length_mm, y = flipper_length_mm,
                    size = body_mass_g)) +
  labs(x = "Bill length (mm)", y = "Flipper length (mm)") +
  facet_wrap(~species, ncol = 1) +
  theme_bw(base_size = 15) +
  theme(legend.position = c(0.9, 0.9))
```

Finally, let's color the female and male penguins with different colors. Note that the default for `geom_phylopic` is to not display a legend, so we need to set `show.legend = TRUE`. However, we only want a legend for the colors, so we use `guide = "none"`:

```{r}
ggplot(subset(penguins, !is.na(sex))) +
  geom_phylopic(img = list(penguin_rot),
                aes(x = bill_length_mm, y = flipper_length_mm,
                    size = body_mass_g, colour = sex),
                show.legend = TRUE) +
  labs(x = "Bill length (mm)", y = "Flipper length (mm)") +
  scale_size_continuous(guide = "none") +
  scale_colour_manual("Sex", values = c("orange", "blue"),
                      labels = c("Female", "Male")) +
  facet_wrap(~species, ncol = 1) +
  theme_bw(base_size = 15) +
  theme(legend.position = c(0.9, 0.9))
```

Now that's a nice figure!

# Geographic distribution
In much the same way as generic x-y plotting, the rphylopic package can be used in combination with ggplot2 (Wickham, 2016) to plot organism silhouettes on a map (Fig. 3). That is, to plot data points (e.g. species occurrences) as silhouettes. We provide an example here of how this might be achieved for individuals who wish to do so. For this application, we use the example occurrence dataset of early (Carboniferous to Early Triassic) tetrapods from the palaeoverse R package (Jones et al., 2023) to visualise the geographic distribution of Mesosaurus fossils.

```{r}
# Load libraries
library(rphylopic)
library(ggplot2)
library(palaeoverse)
# Get occurrence data
data(tetrapods)
# Subset to desired group
tetrapods <- subset(tetrapods, genus == "Mesosaurus")
# Get map data
world <- map_data(map = "world")
# Make map
ggplot() +
  geom_polygon(data = world, aes(x = long, y = lat, group = group), 
               fill = "lightgray", colour = "darkgrey", linewidth = 0.1) +
  geom_phylopic(data = tetrapods, aes(x = lng, y = lat, name = genus),
                size = 4, alpha = 0.75, colour = "blue") +
  theme_void() +
  coord_quickmap()
```

# Phylogenetics
Another common use case of PhyloPic silhouettes is to represent taxonomic information. In this example, we demonstrate how to use silhouettes within a phylogenetic framework (Fig. 4). In this case, the phylogeny includes taxa across all vertebrates. Even many taxonomic experts are unlikely to know the scientific names of these 11 disparate taxa, so we replace the names with PhyloPic silhouettes. We use the ggtree R package (Yu et al., 2017) to plot the phylogeny and the deeptime R package (Gearty, 2023) to add a geological timescale to the background. We use a vectorized version of the get_uuid function to retrieve UUID values for all of the species at once; however, one of the scientific names is not matched in the PhyloPic database so we need to use a higher taxonomic name. We also choose to use the pick_phylopic function to select a specific image for the boar. Note that only a single size is specified and aspect ratio is always maintained, hence why the silhouettes all have the same height but different widths.

```{r eval = FALSE}
# Load libraries
library(rphylopic)
library(ggplot2)
library(ggtree)
library(phytools)
library(deeptime)
# Get vertebrate phylogeny and data
data(vertebrate.tree)
# Make a data.frame for the PhyloPic names
vertebrate.data <- data.frame(species = vertebrate.tree$tip.label, uuid = NA)
# Try to get PhyloPic UUIDs for the species names
vertebrate.data$uuid <- sapply(vertebrate.tree$tip.label,
                               function(x) tryCatch(get_uuid(x),
                                                    error = function(e) NA))
# We're still missing one for the bat, let's use the subfamily
vertebrate.data$uuid[vertebrate.data$species == "Myotis_lucifugus"] <-
  get_uuid("Vespertilioninae")
# Pick a different boar image; e.g. #2
boar_svg <- pick_phylopic("Sus scrofa", view = 5)
# Extract the UUID
vertebrate.data$uuid[vertebrate.data$species == "Sus_scrofa"] <-
  attr(boar_svg, "uuid")
# Plot the tree with a geological timescale in the background
revts(ggtree(vertebrate.tree, size = 1)) %<+% vertebrate.data +
  geom_phylopic(aes(uuid = uuid), size = 25) +
  scale_x_continuous(breaks = seq(-500, 0, 100),
                     labels = seq(500, 0, -100)) +
  coord_geo_polar(dat = "periods") +
  theme(line = element_line(linewidth = 1),
        axis.text.r = element_text(size = 5, hjust = -0.5, vjust = -1.5))
```

</div>
